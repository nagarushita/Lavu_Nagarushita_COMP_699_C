{% extends "base.html" %}

{% block title %}Dashboard - Network Monitor{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h2 class="text-2xl font-bold">{{ dashboard.name if dashboard else 'Dashboard' }}</h2>
    <div class="flex space-x-4">
        <select id="time-range" class="px-3 py-2 border border-gray-300 rounded">
            <option value="24h">Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
        </select>
        <button onclick="refreshDashboard()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            Refresh
        </button>
        {% if dashboard %}
        <a href="{{ url_for('dashboard.view', id=dashboard.id) }}" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
            Edit
        </a>
        {% endif %}
    </div>
</div>

{% if dashboard %}
<div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for widget in dashboard.widgets %}
    <div class="bg-white p-6 rounded-lg border border-gray-200" 
         data-widget-id="{{ widget.id }}" 
         data-widget-type="{{ widget.widget_type }}"
         data-data-source="{{ widget.data_source }}">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">{{ widget.title }}</h3>
        <div class="widget-content" id="widget-{{ widget.id }}" style="min-height: 200px;">
            <div class="flex items-center justify-center h-48">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="bg-white p-12 rounded text-center">
    <p class="text-gray-600 mb-4">No dashboard found. Create one to get started.</p>
    <button onclick="createDashboard()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
        Create Dashboard
    </button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const chartInstances = {};
    
    function refreshDashboard() {
        const timeRange = document.getElementById('time-range').value;
        {% if dashboard %}
        {% for widget in dashboard.widgets %}
        loadWidgetData({{ widget.id }}, timeRange);
        {% endfor %}
        {% endif %}
    }
    
    function loadWidgetData(widgetId, timeRange) {
        const element = document.getElementById(`widget-${widgetId}`);
        element.innerHTML = '<div class="flex items-center justify-center h-32"><div class="loading-spinner"></div></div>';
        
        fetch(`/dashboard/widget/${widgetId}/data?time_range=${timeRange}`)
            .then(r => r.json())
            .then(data => {
                const widgetCard = element.closest('[data-widget-id]');
                const widgetType = widgetCard.dataset.widgetType;
                const dataSource = widgetCard.dataset.dataSource;
                renderWidget(widgetId, data, dataSource);
            })
            .catch(err => {
                element.innerHTML = '<div class="text-red-500 text-sm">Error loading data</div>';
                console.error('Widget load error:', err);
            });
    }
    
    function renderWidget(widgetId, data, dataSource) {
        const element = document.getElementById(`widget-${widgetId}`);
        
        // Destroy existing chart if present
        if (chartInstances[widgetId]) {
            chartInstances[widgetId].destroy();
            delete chartInstances[widgetId];
        }
        
        if (dataSource === 'bandwidth_usage' || dataSource === 'packet_rate') {
            renderLineChart(widgetId, data);
        } else if (dataSource === 'protocol_distribution') {
            renderPieChart(widgetId, data);
        } else if (dataSource === 'top_talkers') {
            renderTopTalkers(widgetId, data);
        } else {
            renderGenericData(widgetId, data);
        }
    }
    
    function renderLineChart(widgetId, data) {
        const element = document.getElementById(`widget-${widgetId}`);
        element.innerHTML = '<canvas id="chart-' + widgetId + '"></canvas>';
        
        const ctx = document.getElementById('chart-' + widgetId).getContext('2d');
        const labels = data.data.map(d => new Date(d.timestamp).toLocaleTimeString());
        const values = data.data.map(d => d.value);
        
        chartInstances[widgetId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: data.unit || 'Value',
                    data: values,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    function renderPieChart(widgetId, data) {
        const element = document.getElementById(`widget-${widgetId}`);
        element.innerHTML = '<canvas id="chart-' + widgetId + '"></canvas>';
        
        const ctx = document.getElementById('chart-' + widgetId).getContext('2d');
        const labels = Object.keys(data);
        const values = Object.values(data);
        
        chartInstances[widgetId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(251, 146, 60)',
                        'rgb(239, 68, 68)',
                        'rgb(168, 85, 247)',
                        'rgb(236, 72, 153)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }
    
    function renderTopTalkers(widgetId, data) {
        const element = document.getElementById(`widget-${widgetId}`);
        
        let html = '<div class="space-y-2 max-h-64 overflow-y-auto">';
        data.slice(0, 10).forEach((talker, idx) => {
            const bytes = formatBytes(talker.bytes);
            html += `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="flex-shrink-0 w-6 h-6 bg-primary-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                            ${idx + 1}
                        </span>
                        <div>
                            <div class="font-mono text-sm font-medium">${talker.ip}</div>
                            <div class="text-xs text-gray-500">${talker.packets.toLocaleString()} packets</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-primary-600">${bytes}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        element.innerHTML = html;
    }
    
    function renderGenericData(widgetId, data) {
        const element = document.getElementById(`widget-${widgetId}`);
        element.innerHTML = '<pre class="text-xs overflow-auto">' + JSON.stringify(data, null, 2) + '</pre>';
    }
    
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function createDashboard() {
        fetch('/dashboard/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: 'My Dashboard'})
        })
        .then(r => r.json())
        .then(data => location.reload());
    }
    
    {% if dashboard %}
    refreshDashboard();
    {% endif %}
</script>
{% endblock %}
